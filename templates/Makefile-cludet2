APP={0[appdir]}
PYTHON3={0[python3]}

#NPLACES=`sed '/^'\#'/d;/^'\$$'/d' ../data/labels.txt |wc -l`
NPLACES=`cat ../data/labels.txt |wc -l`

OK:  {0[target]} ../data/OK

s4: distmap.png selectedforms.txt

distmap.png: distmap.eps
	$(APP)/util/smappost distmap.eps
	$(APP)/util/eps2png

distmap.eps: ../map/map.cfg distmap.rgb
	maprgb -r -o distmap.eps ../map/map.cfg distmap.rgb

tip.html: ../map/image.html currentitem
	$(APP)/util/makelongtip ../map/image.html ../data/_/`cat currentitem`.data tip.html

distmap.rgb: selectedforms.txt currentitem
	$(APP)/util/formstorgb currentitem selectedforms.txt distmap.rgb
	

s3: currentlist.txt tip.html

currentlist.txt: clgroups.txt currentitem currentcl
	$(APP)/util/count_forms \
				clgroups.txt \
				`cat currentcl` \
				../data/_/`cat currentitem`.data \
				| sort -rg \
				> currentlist.txt

s2: score.txt

score.txt: clgroups.txt ../data/_/*.data.ftr currentcl clusterdet-params
	mkdir -p _
	rm -f _/*.diff
	for i in ../data/_/*.data.ftr; do \
		leven-r -n $(NPLACES) \
				-l ../data/labels.txt \
				-s ../data/features-float.txt \
				-o _/`basename $$i .data.ftr`.diff\
				$$i;\
	done
	$(APP)/util/clusterdet -c `cat currentcl` \
		               -C clgroups.txt \
					   `cat clusterdet-params` \
		               _/*.diff | sort -g > score-tmp.txt
	grep -v '\<nan\>' score-tmp.txt > score.txt
	grep '\<nan\>' score-tmp.txt > score-failed.txt



s1: clmap.png

clmap.png: clmap.eps
	$(PYTHON3) $(APP)/util/smappost clmap.eps
	$(APP)/util/eps2png

clmap.eps: map.cfg cluster.wm nclusters
	mapclust -o clmap.eps \
		-u $(APP)/templates/palette12.txt \
		map.cfg cluster.wm `cat nclusters`

map.cfg: ../map/map.cfg
	grep -v ^markers: ../map/map.cfg > map.cfg

clgroups.txt: cluster.wm nclusters
	clgroup -n `cat nclusters` -i -o clgroups.txt cluster.wm

cluster.wm: ../diff/diff.txt
	cluster -o cluster.wm -wm ../diff/diff.txt
